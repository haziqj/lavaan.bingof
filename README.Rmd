---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
library(lavaan.bingof)
library(tidyverse)
```

# lavaan.bingof

<!-- badges: start -->
[![Lifecycle: experimental](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://lifecycle.r-lib.org/articles/stages.html#experimental)
[![R-CMD-check](https://github.com/haziqj/lavaan.bingof/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/haziqj/lavaan.bingof/actions/workflows/R-CMD-check.yaml)
<!-- badges: end -->

<!-- https://github.com/r-lib/pkgdown/issues/133 -->
![](https://raw.githubusercontent.com/haziqj/lavaan.bingof/main/data-raw/mult_bern_data.png)

This is the accompanying R package for the paper

> Goodness-of-fit tests for composite likelihood estimation under simple random and complex survey sampling

This package contains the functions to compute the test statistics and conduct simulation studies described in the above manuscript.

## Installation

Install this package from this GitHub repository:

```{r, eval = FALSE}
# install.packages("pak") 
pak::pkg_install("haziqj/lavaan.bingof")
library(lavaan.bingof)  # load package
```

Note: This package depends on the modified `{lavaan}` package version 0.6-14.9001, which can be installed from the GitHub repository at [`haziqj/lavaan`](https://github.com/haziqj/lavaan).

## Usage

There are three main functionalities of this package:

1. Generate simulated data either from an infinite population or from a finite population using a complex sampling procedure.

2. Obtain the test statistic values, the degrees of freedom of these chi-square variates, and corresponding $p$-values to determine goodness-of-fit.

3. Wrap functions 1 and 2 in a convenient way to perform simulation studies for Type I errors and power.

### Create a simulated data set of ordinal binary responses

```{r}
(dat <- gen_data_bin(n = 1000, seed = 123))
```

### Obtain the various test statistics and $p$-values

```{r}
# Fit lavaan model using PML estimation
(mod <- txt_mod(model.no = 1))
fit <- lavaan::sem(mod, dat, std.lv = TRUE, estimator = "PML")

# Test statistics
all_tests(fit)
```

### Test statistics under a complex sampling scheme

```{r}
# Simulate a two-stage stratified cluster sampling with 50 PSUs sampled per
# stratum, and 1 cluster sampled within each PSU.
(dat <- gen_data_bin_complex3(population = make_population(1), npsu = 50, 
                              seed = 9423))

# Fit lavaan model and create survey object
fit0 <- lavaan::sem(mod, dat, std.lv = TRUE, estimator = "PML")  # ignore wt
fit1 <- lavaan::sem(mod, dat, std.lv = TRUE, estimator = "PML",
                    sampling.weights = "wt")
svy <- survey::svydesign(ids = ~ school + class, strata = ~ type,
                         weights = ~ wt, data = dat, nest = TRUE)

# Compare with and without sampling weights
Wald_test(fit0)
Wald_test(fit1, svy_design = svy)
```

### Simulation wrapper

```{r}
# To conduct a simulation study based on a 5 factor model (32 repetitions only
# for illustration). Data generated according to a stratified complex sample.
(pc <- parallel::detectCores())   # how many cores do we have?

res <- ligof_sims(model.no = 1, nsim = pc, samp = "strat", simtype = "type1",
                  no.cores = pc)
```

<!-- #>|======================================================================| 100% -->

```{r}
# Summarise the average rejection rate
res %>%
  bind_rows() %>%
  group_by(name) %>%
  summarise(rej_rate = mean(pval < 0.1))
```
